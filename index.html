<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <!-- ================= Document & metadata ================= -->
  <meta charset="utf-8" />
  <title>Secret Secret</title>

  <!-- Security: CSP stricte -->
  <meta http-equiv="Content-Security-Policy" content="
      default-src 'self';
      script-src 'self';
      script-src-attr 'none';
      worker-src 'self';
      style-src 'self';
      style-src-attr 'none';
      img-src 'self' data:;
      font-src 'self';
      connect-src 'self';
      frame-src 'none';
      object-src 'none';
      base-uri 'none';
      form-action 'self';
      frame-ancestors 'none';
      require-trusted-types-for 'script';
      trusted-types default worker-url;
    ">

  <!-- Viewport & privacy -->
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="referrer" content="no-referrer" />
  <meta name="color-scheme" content="light dark" />

  <!-- ================= Static assets ================= -->
  <link rel="icon" href="./favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32.png">
  <link rel="icon" type="image/png" sizes="64x64" href="./favicon-64.png">
  <link rel="icon" type="image/png" sizes="128x128" href="./favicon-128.png">

  <!-- ================= Styles ================= -->
  <link rel="stylesheet" href="./styles.css" />

  <!-- ================= Service Worker COI registration ================= -->
  <script src="./register-coi-sw.js" defer></script>

  <!-- ================= App script ================= -->
  <script type="module" src="./app.js"></script>
</head>
<body>
  <!-- ================= Keyboard skip link ================= -->
  <a class="skip" href="#main">Skip to content</a>

  <div class="wrap">
    <!-- ================= Header ================= -->
    <header>
      <!-- Associe explicitement la marque au h1, sans doublon d'annonce -->
      <div class="brand" aria-labelledby="title">
        <div class="logo" aria-hidden="true"></div>
        <h1 id="title">Secret Secret</h1>
      </div>

      <div class="meta" role="region" aria-label="Status and controls">
        <!-- Live region pour infos courtes -->
        <span id="liveInfo" class="muted" role="status" aria-live="polite" aria-atomic="true">Ready</span>
        <!-- Badge de lenteur -->
        <span id="lagBadge" class="badge-warn" hidden aria-live="polite">⚠️ Slow…</span>
        <!-- Bouton annuler benchmark -->
        <button id="btnCancelBench" class="btn secondary" type="button" hidden>Cancel</button>
        <!-- Panic: libellé clair -->
        <button id="btnPanic" class="btn secondary" type="button" aria-label="Clear all local state">Purge</button>
      </div>
    </header>

    <!-- Bandeau d'erreur (alerte assertive) -->
    <div id="errBanner" class="banner error" role="alert" hidden></div>

    <!-- ================= Main ================= -->
    <main id="main" class="card" aria-labelledby="title">
      <!-- Commutateur de mode (ARIA Tabs) -->
      <div class="row" role="tablist" aria-label="Mode" aria-orientation="horizontal">
        <div class="seg">
          <button id="tabEncrypt" class="btn" role="tab" aria-selected="true" tabindex="0" aria-controls="panelEncrypt">Encrypt</button>
          <button id="tabDecrypt" class="btn" role="tab" aria-selected="false" tabindex="-1" aria-controls="panelDecrypt">Decrypt</button>
        </div>
      </div>

      <!-- ===== Panel: Encrypt ===== -->
      <section id="panelEncrypt" role="tabpanel" aria-labelledby="tabEncrypt" tabindex="0">
        <div class="row">
          <div>
            <label for="encPassword">Passphrase</label>
            <div class="input-actions" aria-describedby="passHelp">
              <input id="encPassword" type="password" inputmode="text" autocomplete="new-password" aria-describedby="pwdStrength passHelp" />
              <button id="encPwdToggle" class="btn secondary" type="button" aria-pressed="false" aria-controls="encPassword" aria-label="Show passphrase">Show</button>
              <button id="encPwdGen" class="btn secondary" type="button">Generate</button>
            </div>
            <div id="passHelp" class="muted">Use a 4+ word phrase or 16+ characters.</div>
            <div class="inline muted">
              <div id="pwdStrength" class="status" role="status" aria-live="polite" aria-atomic="true"></div>
            </div>
          </div>
        </div>

        <fieldset class="row mt-8">
          <legend>Content</legend>
          <!-- Content type (text vs files) -->
          <div class="row" role="tablist" aria-label="Content type" aria-orientation="horizontal">
            <div class="seg w-max">
              <button id="encTabText"  class="btn" role="tab" aria-selected="true"  tabindex="0"  aria-controls="encPanelText">Text</button>
              <button id="encTabFiles" class="btn" role="tab" aria-selected="false" tabindex="-1" aria-controls="encPanelFiles">Files</button>
            </div>
          </div>

          <!-- Text content -->
          <div id="encPanelText" role="tabpanel" aria-labelledby="encTabText" tabindex="0">
            <label for="encText">Text to encrypt</label>
            <textarea id="encText" placeholder="Paste or type your text…" aria-label="Text to encrypt" spellcheck="false"></textarea>
          </div>

          <!-- Files content -->
          <div id="encPanelFiles" role="tabpanel" aria-labelledby="encTabFiles" tabindex="0" hidden>
            <!-- Dropzone liée à l'input via label/for, meilleur support clavier/AT -->
            <label id="encDrop" class="drop" for="encFiles"
                   role="button" tabindex="0"
                   aria-label="Drag and drop files or press Enter to browse"
                   aria-describedby="encDropHint encFilesHelp">
              <div class="drop-labels">
                <strong>Drag & drop files here</strong>
                <p class="muted" id="encDropHint">or tap/click to select</p>
              </div>
            </label>
            <input id="encFiles" type="file" accept="*/*" multiple hidden aria-describedby="encFilesHelp">
            <div id="encFilesHelp" class="muted">You can select multiple files.</div>

            <ul id="encFileList" class="muted" aria-live="polite" aria-atomic="false" aria-relevant="additions removals"></ul>
          </div>
        </fieldset>
        
        <!-- Sticky actions -->
        <div class="actionbar" role="region" aria-label="Encryption actions">
          <div class="buttons">
            <button id="btnEncrypt" class="btn primary" type="button" disabled aria-disabled="true">Encrypt</button>
            <button id="btnClearEncrypt" class="btn secondary" type="button">Clear</button>
          </div>
          <!-- Progress (Text) -->
          <div id="encProgText" class="progress mt-10" aria-label="Encryption progress (Text)">
            <span id="encBarLabelText" class="visually-hidden">Encryption progress (Text)</span>
            <div id="encBarText" class="bar"
                 role="progressbar"
                 aria-labelledby="encBarLabelText"
                 aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"></div>
          </div>
          <!-- Progress (Files) -->
          <div id="encProgFiles" class="progress mt-10 hidden" aria-label="Encryption progress (Files)">
            <span id="encBarLabelFiles" class="visually-hidden">Encryption progress (Files)</span>
            <div id="encBarFiles" class="bar"
                 role="progressbar"
                 aria-labelledby="encBarLabelFiles"
                 aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"></div>
          </div>
          <!-- Results (Text) — same structure as Decrypt -->
          <details id="encDetailsText" class="muted hidden">
            <summary>Results</summary>
            <div id="encResultsText" class="row hidden" role="status" aria-live="polite" aria-atomic="true"></div>
            <pre id="encPreviewText" class="card hidden" aria-label="Encrypted text preview"></pre>
            <div id="encHashText" class="status"></div>
          </details>
          <!-- Results (Files) — same structure as Decrypt -->
          <details id="encDetailsFiles" class="muted hidden">
            <summary>Results</summary>
            <div id="encResultsFiles" class="row hidden" role="status" aria-live="polite" aria-atomic="true"></div>
            <pre id="encPreviewFiles" class="card hidden" aria-label="Encrypted files preview"></pre>
            <div id="encHashFiles" class="status"></div>
          </details>
        </div>
      </section>

      <!-- ===== Panel: Decrypt ===== -->
      <section id="panelDecrypt" role="tabpanel" aria-labelledby="tabDecrypt" tabindex="0" hidden>
        <div class="row">
          <div>
            <label for="decPassword">Passphrase</label>
            <div class="input-actions">
              <input id="decPassword" type="password" inputmode="text" autocomplete="current-password" />
              <button id="decPwdToggle" class="btn secondary" type="button" aria-pressed="false" aria-controls="decPassword" aria-label="Show passphrase">Show</button>
            </div>
          </div>
        </div>

        <div class="row mt-8">
          <div>
            <label for="decFile">Envelope file</label>

            <!-- Dropzone accessible liée au file input -->
            <label id="decDrop" class="drop" for="decFile"
                   role="button" tabindex="0"
                   aria-label="Drop a .cbox or .cboxbundle file or press Enter to browse"
                   aria-describedby="decDropHint">
              <div class="drop-labels">
                <strong>Drop a .cbox / .cboxbundle</strong>
                <p class="muted" id="decDropHint">or tap/click to select</p>
              </div>
            </label>

            <input id="decFile" type="file" accept=".cbox,.cboxbundle"
                   aria-label="Choose a .cbox or .cboxbundle file" hidden>

            <div id="decFileName" class="muted" role="status" aria-live="polite" aria-atomic="true"></div>
            <div id="decFileErr" class="muted status" role="alert" aria-atomic="true"></div>
          </div>
        </div>

        <div class="actionbar" role="region" aria-label="Decryption actions">
          <div class="buttons">
            <button id="btnDecrypt" class="btn primary" type="button" disabled aria-disabled="true">Decrypt</button>
            <button id="btnClearDecrypt" class="btn secondary" type="button">Clear</button>
          </div>

          <div class="progress mt-10" aria-label="Decryption progress">
            <span id="decBarLabel" class="visually-hidden">Decryption progress</span>
            <div id="decBar" class="bar"
                 role="progressbar"
                 aria-labelledby="decBarLabel"
                 aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"></div>
          </div>

          <details id="decDetails" class="muted">
            <summary>Results</summary>
            <div id="decResults" class="row hidden" role="status" aria-live="polite" aria-atomic="true"></div>
            <pre id="decText" class="card" hidden aria-label="Decrypted text"></pre>
            <div id="decIntegrity" class="status" role="status" aria-live="polite" aria-atomic="true"></div>
          </details>
        </div>
      </section>
    </main>

    <!-- ================= Footer ================= -->
    <footer role="contentinfo">
      <p class="trust-message">All encryption and decryption runs locally in your browser. No data ever leaves your device.</p>
    </footer>
  </div>
</body>
</html>
